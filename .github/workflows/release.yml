name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run tests
      run: mvn clean test

    - name: Build with Maven
      run: mvn clean package -DskipTests

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## üöÄ FlowMachine ${{ github.ref_name }}

          ## Version 1.2.0
          
          ### ‚ú® New Features
          - **NEW MODULE**: `flowmachine-test` - Comprehensive testing framework for state machines
          - **Testing API**: Fluent builder pattern for creating test scenarios with transitions and validations
          - **Diagram Generation**: Enhanced PlantUML and Mermaid diagram generators with SLF4J logging
          
          ### üîß Improvements
          - **Performance**: Removed unnecessary caching and defensive copying for better memory usage
          - **Code Quality**: Standardized null checking patterns and improved error handling
          - **Logging**: Upgraded diagram generators to use SLF4J with text blocks for cleaner output
          - **Validation**: Enhanced validation logic with better error reporting
          - **API Cleanup**: Simplified builder patterns and removed timeout functionality from testing
          
          ### üõ†Ô∏è Technical Changes
          - **Dependencies**: Centralized version management and upgraded to latest versions (JUnit 5.11.0, Mockito 5.20.0, Cucumber 7.14.0)
          - **Architecture**: Simplified internal data structures and removed premature optimizations
          - **Documentation**: Enhanced JavaDoc and code examples throughout
          
          ### üêõ Bug Fixes
          - Fixed silent exception swallowing in listener methods
          - Corrected validation logic for duplicate transitions
          - Resolved JUnit Platform compatibility issues
          
          ### üîÑ Migration Guide
          - **No breaking changes** - existing code continues to work without modifications
          - **New**: Use `flowmachine-test` module for comprehensive state machine testing
          - **Optional**: Update logging configuration for improved diagram output
